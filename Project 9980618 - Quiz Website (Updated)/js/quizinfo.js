function showQuizStart(){"registered"==userSituation?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!1)):($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0)),setInterval(populateLeaders,15e3)}function updatePrizes(){$.get("./php/quizzes/getnewprizes.php",{quizID:quiz.quizID},function(e){"success"==e[0]?(quiz.pointsRewards=e[1],populatePrizes()):"notchecked"==e?updatePrizesTimer=setTimeout(updatePrizes,5e3):"cancelled"==e?(displayMessage("warning","Quiz Cancelled","This quiz has been cancelled because not enough users registered for it. You have been refunded the quiz fee plus 1 bonus quizeto."),$("#quizInfoRegistration").html("<div>QUIZ CANCELLED</div>"),$("#quizInfoCountdown").hide()):displayMessage("error","Error","Error checking if prizes have been updated")},"json").fail(function(){})}function stopUnregistration(){"registered"==userSituation&&($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),startQuizTimer=setTimeout(showQuizStart,moment(quiz.startTime).diff(moment())-1e3))}function stopQuizStart(){$("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),populateQuestions()}function populateTitle(){var e="";if(e+="<!-- AddToAny BEGIN -->",e+='<div class="a2a_kit a2a_kit_size_32 a2a_default_style socialButtons">',e+='    <a class="a2a_button_facebook"></a>',e+='    <a class="a2a_button_twitter"></a>',e+='    <a class="a2a_button_google_plus"></a>',e+='    <a class="a2a_button_pinterest"></a>',e+='    <a class="a2a_button_linkedin"></a>',e+='    <a class="a2a_button_tumblr"></a>',e+="</div>",e+='<script async src="https://static.addtoany.com/menu/page.js"></script>',e+="<!-- AddToAny END -->",editable){var t=quiz.category,i=t.indexOf(" by");e+="<div id='title'><span class='category editable' contenteditable='true'>"+t.substr(0,i).toUpperCase()+"</span>"+t.substr(i).toUpperCase()+"</div>"}else e+="<div id='title'>"+quiz.category.toUpperCase()+"</div>";$("#quizInfoTitle").html(e)}function populateCountdown(){var e,t;moment(quiz.startTime).diff(moment())>0?(e=Math.floor(moment(quiz.startTime).diff(moment())/1e3),t="Starts in"):moment(quiz.endTime).diff(moment())>0?(e=Math.floor(moment(quiz.endTime).diff(moment())/1e3),t="Ends in"):(e=-1,t="Ended");var i=60,s=3600,o=86400,a=Math.floor(e/o),n=Math.floor((e-a*o)/s),r=Math.floor((e-(n*s+a*o))/i),d=Math.floor(e-(n*s+a*o+r*i)),u=pad(a,2)+pad(n,2)+pad(r,2)+pad(d,2),l="";l+="<div id='quizSituationTitle'>Quiz "+t+"</div>","Ended"!=t&&(l+="<div>",l+="    <div class='col-xs-3'>",l+="        <div class='col-xs-6 digits'>"+u[0]+"</div>",l+="        <div class='col-xs-6 digits'>"+u[1]+"</div>",l+="    </div>",l+="    <div class='col-xs-3'>",l+="        <div class='col-xs-6 digits'>"+u[2]+"</div>",l+="        <div class='col-xs-6 digits'>"+u[3]+"</div>",l+="    </div>",l+="    <div class='col-xs-3'>",l+="        <div class='col-xs-6 digits'>"+u[4]+"</div>",l+="        <div class='col-xs-6 digits'>"+u[5]+"</div>",l+="    </div>",l+="    <div class='col-xs-3'>",l+="        <div class='col-xs-6 digits'>"+u[6]+"</div>",l+="        <div class='col-xs-6 digits'>"+u[7]+"</div>",l+="    </div>",l+="</div>",l+="<div>",l+="    <div class='col-xs-3'>Days</div>",l+="    <div class='col-xs-3'>Hours</div>",l+="    <div class='col-xs-3'>Minutes</div>",l+="    <div class='col-xs-3'>Seconds</div>",l+="</div>"),$("#quizInfoCountdown").html(l),"Ended"==t&&$("#quizSituationTitle").css("padding-top","2rem")}function populateInfo(){var e="";e+='<div class="scrollable">',e+="<table>",e+="    <tr>",e+='        <th colspan="2">Quiz Info</th>',e+="    </tr>",e+="    <tr>",e+='        <td class="subheading">Start Time</td>',e+='        <td class="value'+(editable?' editable" onclick="showTimeslotChange()':"")+'">'+moment(quiz.startTime).format("ddd Do MMM YYYY h:mm a")+"</td>",e+="    </tr>",e+="    <tr>",e+='        <td class="subheading">End Time</td>',e+='        <td class="value">'+moment(quiz.endTime).format("ddd Do MMM YYYY h:mm a")+"</td>",e+="    </tr>",e+="    <tr>",e+='        <td class="subheading">Number of Questions</td>',e+='        <td class="value">'+JSON.parse(quiz.questions).length+"</td>",e+="    </tr>",e+="    <tr>",e+='        <td class="subheading">Registered Players</td>',e+='        <td class="value">'+JSON.parse(quiz.userRegistered).length+"</td>",e+="    </tr>",e+="    <tr>",e+='        <td class="subheading">Registration Fee</td>',e+='        <td class="value'+(editable?' pointsCost editable" contenteditable="true"':"")+'">'+quiz.pointsCost+"</td>",e+="    </tr>",e+="</table>",e+="</div>",$("#quizInfoInfo").html(e),1===count?(addContentEditableEvents(),count=0):count+=1}function populateLeaders(){if(moment().isAfter(moment(quiz.startTime)))$.post("./php/quizresults/getquizresults.php",{quizID:quiz.quizID},function(e){if("success"==e[0]){var t=e[1],i="";i+='<div class="scrollable">',i+="<table>",i+="    <tr>",i+='        <th colspan="2">Leaderboard</th>',i+="    </tr>";for(var s=0;null!==t&&15>s&&s<t.length;s+=1)i+="    <tr>",i+="        <td>"+(s+1)+place[s>3?3:s]+"</td>",i+='        <td><img class="leaderboardUserImage" src="./images/users/'+t[s].imageURL+'" /></td>',i+="        <td>"+t[s].username+"</td>",i+="        <td>"+t[s].correctPercent+"%</td>",i+="        <td>"+t[s].timeTaken/1e3+" secs</td>",i+="    </tr>";i+="</table>",i+="</div>",$("#quizInfoLeader").html(i)}else displayMessage("error","Error","Error: "+e[1])},"json").fail(function(){});else{var e="";e+="<table>",e+="    <tr>",e+='        <th colspan="2">Leaderboard</th>',e+="    </tr>",e+="    <tr>",e+="        <td>Leaderboard will be shown after the quiz starts.</td>",e+="    </tr>",e+="</table>",$("#quizInfoLeader").html(e)}}function populateRegistration(){$.post("./php/quizzes/checkregistration.php",{userID:sessionStorage.userID,quizID:quiz.quizID},function(e){userSituation=e;var t=Math.floor(moment(quiz.startTime).diff(moment())/1e3),i=Math.floor(moment(quiz.endTime).diff(moment())/1e3),s="";s+="<table>",s+="    <tr>",s+="        <th colspan='2'>",s+="            Registration",s+="        </th>",s+="    </tr>",s+="    <tr>",s+="        <td>",s+="            <button id='registerButton' onclick='registerQuiz("+quiz.quizID+', "'+quiz.type+"\")'>REGISTER</button>",s+="        </td>",s+="        <td>",s+="            <button id='unregisterButton' onclick='unregisterQuiz("+quiz.quizID+")'>UNREGISTER</button>",s+="        </td>",s+="    </tr>",s+="    <tr>",s+="        <td colspan='2'>",s+="            <button id='startButton' onclick='startQuiz("+quiz.quizID+")'>START</button>",s+="        </td>",s+="    </tr>",s+="</table>",$("#quizInfoRegistration").html(s).show(),1==quiz.quizID||2==quiz.quizID?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!1),$("#quizInfoCountdown").hide()):"cancelled"==e?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),$("#quizInfoCountdown").hide()):t>=600&&"registered"==e?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!1),$("#startButton").prop("disabled",!0)):t>=0&&"notregistered"==e?($("#registerButton").prop("disabled",!1),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),startQuizTimer=setTimeout(showQuizStart,moment(quiz.startTime).diff(moment())-1e3)):t>=0&&600>t&&"registered"==e?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),startQuizTimer=setTimeout(showQuizStart,moment(quiz.startTime).diff(moment())-1e3)):i>0&&0>=t&&"registered"==e?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!1),setInterval(populateLeaders,15e3)):i>=0&&"notregistered"==e?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),setInterval(populateLeaders,15e3)):i>=0&&"alreadydone"==e?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),setInterval(populateLeaders,15e3)):i>=0?($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),displayMessage("error","Error","Error checking if you are registered for this quiz or if you have already completed the quiz. Please contact web admin about this problem.")):($("#registerButton").prop("disabled",!0),$("#unregisterButton").prop("disabled",!0),$("#startButton").prop("disabled",!0),populateQuestions()),1===count?(addContentEditableEvents(),count=0):count+=1}).fail(function(){})}function populatePrizes(){var e="";if(e+='<div class="scrollable">',e+="<table>",e+="    <tr>",e+='        <th colspan="2">Prize Pool</th>',e+="    </tr>","paid"==quiz.type){var t=0,i=JSON.parse(quiz.pointsRewards);i.forEach(function(e){t+=parseInt(e)}),e+="    <tr>",e+='        <td class="subheading">Prize Pool</td>',e+='        <td class="value">'+t+"</td>",e+="    </tr>",e+="    <tr>",e+='        <td class="subheading">Prize Type</td>',e+='        <td class="value">Real Quizetos</td>',e+="    </tr>",e+="    <tr>",e+='        <td class="subheading">Number of Places</td>',e+='        <td class="value">'+i.length+"</td>",e+="    </tr>";for(var s=0;s<i.length;s+=1)e+="    <tr>",e+='        <td class="subheading">'+(s+1)+place[s>3?3:s]+"</td>",e+='        <td class="value">'+i[s]+"</td>",e+="    </tr>"}else e+="    <tr>",e+='        <td class="subheading">Prize</td>',e+='        <td class="value">5 quizeto for 100%<br />3 quizeto for 95-99%<br />1 quizeto for 90-94%</td>',e+="    </tr>";e+="</table>",e+="</div>",$("#quizInfoPrizes").html(e)}function populateRules(){var e="",t=JSON.parse(quiz.rules);e+='<div class="scrollable">',e+="<table>",e+="    <tr>",e+='        <th colspan="2">Quiz Rules</th>',e+="    </tr>";for(var i=0;i<t.length;i+=1)e+="    <tr>",e+='        <td class="subheading">'+(i+1)+".</td>",e+='        <td class="subheading">'+t[i]+"</td>",e+="    </tr>";e+="</table>",e+="</div>",$("#quizInfoRules").html(e)}function populateQuestions(){var e="";e+='<div class="scrollable">',e+="<table>",e+="    <tr>",e+='        <th colspan="2">Knowledge Bank</th>',e+="    </tr>";var t=moment().diff(moment(quiz.endTime));if(t>-5e3){for(var i=JSON.parse(quiz.questions),s=0;s<i.length;s+=1)e+="    <tr>",e+='        <td class="subheading">'+i[s][0]+"</td>",e+='        <td class="subheading">'+i[s][1][i[s][2]]+"</td>",e+="    </tr>";e+="</table>",e+="</div>",$("#quizInfoQuestions").html(e)}else e+="    <tr>",e+='        <td class="subheading">The questions and answers will be shown after the quiz ends.</td>',e+="    </tr>",e+="</table>",e+="</div>",$("#quizInfoQuestions").html(e)}function registerQuiz(e,t){var i;"free"==t&&(i=confirm("Do you want to take the quizetos from your bonus quizetos balance?")?"convertable":"unconvertable"),$.post("./php/quizzes/registerquiz.php",{userID:sessionStorage.userID,quizID:quiz.quizID,balance:i},function(e){"success"==e[0]?(populateRegistration(),updatePoints(),displayMessage("info","Registration Successful","You have been registered for this quiz.")):"notenoughpoints"==e[0]?displayMessage("info","Insufficient Quizetos","You don't have enough quizetos for this quiz."):displayMessage("error","",e[1])},"json").fail(function(){})}function unregisterQuiz(){$.post("./php/quizzes/unregisterquiz.php",{userID:sessionStorage.userID,quizID:quiz.quizID},function(e){"success"==e[0]?(populateRegistration(),updatePoints(),displayMessage("info","Unregistration Successful","You have been unregistered from this quiz.")):displayMessage("error","",e[1])},"json").fail(function(){})}function startQuiz(e){sessionStorage.quizID=e,window.location="quiz.php"}function addContentEditableEvents(){$("[contenteditable=true]").on({blur:function(){var e=$(this)[0].className,t=$(this).text();"category"===e&&(t+=" by "+sessionStorage.username),$.post("./php/quizzes/updatequizinfo.php",{quizID:quiz.quizID,column:e,value:t},function(e){"success"==e?displayMessage("info","","Quiz info updated"):displayMessage("error","","Error updating quiz info. Please use the contact form to inform the web admin of this problem.")}).fail(function(){})},focus:function(){sessionStorage.contenteditable=$(this).text()}})}function showTimeslotChange(){var e="";e+="<div id='quizMasterQuizDate'></div>",e+="<table id='quizMasterQuizStartTimeTable'>";for(var t=0;24>t;t+=1){e+="<tr>";for(var i=0;6>i;i+=1)e+="<td class='ts"+pad(t,2)+pad(10*i,2)+"' onclick='selectTimeSlot(this)'>"+(t>12?t-12:0===t?12:t)+":"+pad(10*i,2)+(t>11?"pm":"am")+"</td>";e+="</tr>"}e+="</table>",$("#startTimeChangeModal .modal-body").empty().append(e),$("#quizMasterQuizDate").datetimepicker({format:"dd/MM/YYYY",inline:!0}),$("#quizMasterQuizDate").on("dp.change",function(){disableTimeSlots()}),disableTimeSlots(),$("#startTimeChangeModal").modal()}function selectTimeSlot(e){$(".selectedTimeSlot").removeClass("selectedTimeSlot"),$(e).addClass("selectedTimeSlot")}function disableTimeSlots(){$.get("./php/quizzes/getstarttimefromalluserscheduledquizzes.php",{},function(e){if("fail"===e.substr(0,4))displayMessage("error","","Error getting the used timeslots. Please use the contact form to inform the web admin of this problem.");else{var t=JSON.parse(e);$(".selectedTimeSlot").removeClass("selectedTimeSlot"),$(".usedTimeSlot").removeClass("usedTimeSlot").on("onclick","selectTimeSlot(this)");var i=$("#quizMasterQuizDate").data("DateTimePicker").date().format("YYYY-MM-DD");t.forEach(function(e){var t=moment(e.startTime).local();t.format("YYYY-MM-DD")===i&&$(".ts"+t.format("HH")+t.format("mm")).addClass("usedTimeSlot").prop("onclick","")})}}).fail(function(){})}function saveTimeChange(){if(0!==$(".selectedTimeSlot").length){var e=$("#quizMasterQuizDate").data("DateTimePicker").date(),t=$(".selectedTimeSlot")[0].className;e.set({hour:parseInt(t.substr(2,2)),minute:parseInt(t.substr(4,2))});var i=e.utc().toISOString();$.post("./php/quizzes/changequizstarttime.php",{quizID:quiz.quizID,startTime:i},function(t){"success"==t?($("#quizInfoTable1 tr:eq(0) td:eq(1)").text(e.local().format("ddd Do MMM YYYY h:mm a")),$("#quizInfoTable1 tr:eq(1) td:eq(1)").text(e.add(2,"minutes").local().format("ddd Do MMM YYYY h:mm a")),quiz.startTime=e,quiz.startTime=e.add(2,"minutes"),updateCountdownsTimer(),displayMessage("success","","Quiz start time changed")):displayMessage("error","","Error saving start time change. Please contact web admin about this problem.")}).fail(function(){})}}var quiz,clock,startQuizTimer,registrationQuizTimer,updatePrizesTimer,endQuizTimer,isLeaderboardExpanded=!1,editable,count=0,userSituation;window.onload=function(){if(global(),$("li.active").removeClass("active"),$("#quizzesMenuItem").addClass("active"),"true"!==sessionStorage.loggedIn)displayMessage("warning","You must be logged in to see this.","You need to either login above or signup for an account on the home page.");else{$("#showIfLoggedIn").show();var e=getUrlVars().id;$.post("./php/quizzes/getquizinfo.php",{id:e},function(e){"success"==e[0]?(quiz=e[1],editable="true"==getUrlVars().editable&&moment(quiz.startTime).diff(moment())>144e5&&sessionStorage.username==quiz.creatorUsername?!0:!1,populateTitle(),1!=quiz.quizID&&2!=quiz.quizID&&populateCountdown(),populateInfo(),populateLeaders(),populateRegistration(),populatePrizes(),populateRules(),populateQuestions(),1!=quiz.quizID&&2!=quiz.quizID&&(moment(quiz.startTime).diff(moment())>6e5&&(registrationQuizTimer=setTimeout(stopUnregistration,moment(quiz.startTime).diff(moment())-6e5)),moment(quiz.startTime).diff(moment())>12e4&&(updatePrizesTimer=setTimeout(updatePrizes,moment(quiz.startTime).diff(moment())-12e4)),endQuizTimer=setTimeout(stopQuizStart,moment(quiz.endTime).diff(moment())),setInterval(populateCountdown,1e3))):displayMessage("error","Error","Error: "+e[1])},"json").fail(function(){})}};
